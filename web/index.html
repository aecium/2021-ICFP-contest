<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Free Tacos ICFP Contest 2021 - Visualization and Submission Tool</title>
		<style type="text/css">
			body { font-family: monospace; }
			textarea { width: 100%; }
			.error li {
				background-color: #a00;
				border: 1px solid #900;
				border-radius: 3px;
				padding: 3px;
				color: #fff;
			}
			.row {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				width: 100%;
			}
			.column {
				display: flex;
				flex-direction: column;
				flex-basis: 100%;
				flex: 1;
			}
		</style>
	</head>
	<body>
		<h1>Free Tacos ICFP Contest 2021 - Visualization and Submission Tool</h1>

		<div>
			<label for="problem-data">Problem</label>
			<textarea id="problem-data">{"hole":[[45,80],[35,95],[5,95],[35,50],[5,5],[35,5],[95,95],[65,95],[55,80]],"epsilon":150000,"figure":{"edges":[[2,5],[5,4],[4,1],[1,0],[0,8],[8,3],[3,7],[7,11],[11,13],[13,12],[12,18],[18,19],[19,14],[14,15],[15,17],[17,16],[16,10],[10,6],[6,2],[8,12],[7,9],[9,3],[8,9],[9,12],[13,9],[9,11],[4,8],[12,14],[5,10],[10,15]],"vertices":[[20,30],[20,40],[30,95],[40,15],[40,35],[40,65],[40,95],[45,5],[45,25],[50,15],[50,70],[55,5],[55,25],[60,15],[60,35],[60,65],[60,95],[70,95],[80,30],[80,40]]}}</textarea>
		</div>

		<div>
			<label for="solution-data">Solution</label>
			<textarea id="solution-data">{"vertices": [
				[21, 28], [31, 28], [31, 87], [29, 41], [44, 43], [58, 70],
				[38, 79], [32, 31], [36, 50], [39, 40], [66, 77], [42, 29],
				[46, 49], [49, 38], [39, 57], [69, 66], [41, 70], [39, 60],
				[42, 25], [40, 35]
			]}</textarea>
			<ul id="solution-errors" class="error"></ul>
		</div>

		<div>
			<button id="redraw" onclick="redraw()">Redraw</button>
			<button id="reset" onclick="resetSolution(); redraw();">Reset Solution</button>
		</div>

		<div class="row">
			<div class="column">
				<p>Epsilon: <span id="epsilon"></span></p>
				<p>Max Ratio: <span id="max-ratio"></span></p>
				<h2>Edges:</h2>
				<table id="edges-table">
					<thead>
						<tr>
							<th></th>
							<th>X1</th>
							<th>Y1</th>
							<th>X2</th>
							<th>Y2</th>
							<th>Old Length²</th>
							<th>New Length²</th>
							<th>Ratio</th>
						</tr>
					</thead>
					<tbody id="epsilon-table-body">

					</tbody>
				</table>
				<ul id="epsilon"></ul>
			</div>
			<div class="column">
				<svg id="vis" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0.0 0.0 100.0 100.0">
					<path id="hole" d="M 45.0,80.0 L 35.0,95.0 L 5.0,95.0 L 35.0,50.0 L 5.0,5.0 L 35.0,5.0 L 95.0,95.0 L 65.0,95.0 L 55.0,80.0 Z M 0.0,0.0 L 100.0,0.0 L 100.0,100.0 L 0.0,100.0" style="fill:#00000066;fill-rule:evenodd;stroke:none;" />
					<g id="figure" style="fill:none;stroke:#ff000044;stroke-linecap:round" transform="translate(0.0, 0.0)">
						<path d="M 30.0,95.0 L 40.0,65.0" />
						<path d="M 40.0,65.0 L 40.0,35.0" />
						<path d="M 40.0,35.0 L 20.0,40.0" />
						<path d="M 20.0,40.0 L 20.0,30.0" />
						<path d="M 20.0,30.0 L 45.0,25.0" />
						<path d="M 45.0,25.0 L 40.0,15.0" />
						<path d="M 40.0,15.0 L 45.0,5.0" />
						<path d="M 45.0,5.0 L 55.0,5.0" />
						<path d="M 55.0,5.0 L 60.0,15.0" />
						<path d="M 60.0,15.0 L 55.0,25.0" />
						<path d="M 55.0,25.0 L 80.0,30.0" />
						<path d="M 80.0,30.0 L 80.0,40.0" />
						<path d="M 80.0,40.0 L 60.0,35.0" />
						<path d="M 60.0,35.0 L 60.0,65.0" />
						<path d="M 60.0,65.0 L 70.0,95.0" />
						<path d="M 70.0,95.0 L 60.0,95.0" />
						<path d="M 60.0,95.0 L 50.0,70.0" />
						<path d="M 50.0,70.0 L 40.0,95.0" />
						<path d="M 40.0,95.0 L 30.0,95.0" />
						<path d="M 45.0,25.0 L 55.0,25.0" />
						<path d="M 45.0,5.0 L 50.0,15.0" />
						<path d="M 50.0,15.0 L 40.0,15.0" />
						<path d="M 45.0,25.0 L 50.0,15.0" />
						<path d="M 50.0,15.0 L 55.0,25.0" />
						<path d="M 60.0,15.0 L 50.0,15.0" />
						<path d="M 50.0,15.0 L 55.0,5.0" />
						<path d="M 40.0,35.0 L 45.0,25.0" />
						<path d="M 55.0,25.0 L 60.0,35.0" />
						<path d="M 40.0,65.0 L 50.0,70.0" />
						<path d="M 50.0,70.0 L 60.0,65.0" />
					</g>
					<g id="solution" style="fill:none;stroke:#00ff0088;stroke-linecap:round" transform="translate(0.0, 0.0)">
						<path d="M 10.0,85.0 L 30.0,55.0" />
						<path d="M 30.0,55.0 L 30.0,25.0" />
					</g>
				</svg>
			</div>
		</div>

<script>
	function pathToHole(points) {
		let hole = '';
		let op = 'M ';
		for(const point of points){
			hole += op + point[0] + "," + point[1];
			op = ' L ';
		}
		console.log(hole);
		console.log('M 45.0,80.0 L 35.0,95.0 L 5.0,95.0 L 35.0,50.0 L 5.0,5.0 L 35.0,5.0 L 95.0,95.0 L 65.0,95.0 L 55.0,80.0 Z M 0.0,0.0 L 100.0,0.0 L 100.0,100.0 L 0.0,100.0');
		return hole + ' Z M 0.0,0.0 L 100.0,0.0 L 100.0,100.0 L 0.0,100.0';
	}

	function setElementPaths(element, edges, vertices) {
		while(element.firstChild) {
			element.removeChild(element.firstChild);
		}

		for(const edge of edges){
			let path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
			let p1 = vertices[edge[0]]
			let p2 = vertices[edge[1]];
			path.setAttribute('d', 'M ' + p1[0] + ',' + p1[1] + ' L ' + p2[0] + ',' + p2[1]);
			element.appendChild(path);
		}
	}

	function parseSolutionData(problemData, solutionString) {
		let solutionData = {}
		let errorList = document.getElementById('solution-errors');
		while(errorList.firstChild) {
			errorList.removeChild(errorList.firstChild);
		}

		try {
			solutionData = JSON.parse(solutionString);
		} catch (error) {
			console.error("Could not parse solution.");
			console.error(error);
			let li = document.createElement('li');
			li.textContent = "" + error;
			errorList.appendChild(li);
			throw error;
		}
		return solutionData;
	}

	function redraw() {
		let svg = document.getElementById('vis');
		let hole = document.getElementById('hole');
		let figure = document.getElementById('figure');
		let solution = document.getElementById('solution');
		let problemData = JSON.parse(document.getElementById('problem-data').value);
		console.log(document.getElementById('solution-data').value);

		hole.setAttribute('d', pathToHole(problemData.hole));
		setElementPaths(figure, problemData.figure.edges, problemData.figure.vertices);

		let solutionData = {};

		try {
			solutionData = parseSolutionData(problemData, document.getElementById('solution-data').value);
			setElementPaths(solution, problemData.figure.edges, solutionData.vertices);
		} catch(error) {
			return;
		}

	}

	function resetSolution() {
		let problemData = JSON.parse(document.getElementById('problem-data').value);
		document.getElementById('solution-data').value = JSON.stringify({"vertices":problemData.figure.vertices});
	}

	function squaredDistance(p, q) {
		return ((p[0] - q[0]) ** 2) + ((p[1] - q[1]) ** 2)
	}

	function calculateRatio(oldEdge, newEdge) {
		return Math.abs((squaredDistance(newEdge[0], newEdge[1]) / squaredDistance(oldEdge[0], oldEdge[1])) - 1);
	}

	function populateEpsilonTable(table, epsilon, edges, oldVertices, vertices) {
		while(table.firstChild) {
			table.removeChild(table.firstChild);
		}

		let i=0;
		for(const edge of edges){
			let p1 = vertices[edge[0]]
			let p2 = vertices[edge[1]];
			let oldP1 = oldVertices[edge[0]]
			let oldP2 = oldVertices[edge[1]];
			let newLength = squaredDistance(p1, p2);
			let oldLength = squaredDistance(oldP1, oldP2);
			let ratio = calculateRatio([oldP1, oldP2], [p1, p2]);

			document.getElementById('epsilon').textContent = epsilon;
			document.getElementById('max-ratio').textContent = epsilon/1000000;

			let tr = document.createElement('tr');
			let td = document.createElement('td');
			td.textContent = i;
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = p1[0];
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = p1[1];
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = p2[0];
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = p2[1];
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = oldLength;
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = newLength;
			tr.appendChild(td);

			td = document.createElement('td');
			td.textContent = ratio;
			tr.appendChild(td);

			//path.setAttribute('d', 'M ' + p1[0] + ',' + p1[1] + ' L ' + p2[0] + ',' + p2[1]);
			//element.appendChild(path);
			table.appendChild(tr);
			i++;

		}
	}

	function redraw() {
		let svg = document.getElementById('vis');
		let hole = document.getElementById('hole');
		let figure = document.getElementById('figure');
		let solution = document.getElementById('solution');
		let problemData = JSON.parse(document.getElementById('problem-data').value);

		hole.setAttribute('d', pathToHole(problemData.hole));
		setElementPaths(figure, problemData.figure.edges, problemData.figure.vertices);

		let solutionData = {};

		try {
			solutionData = parseSolutionData(problemData, document.getElementById('solution-data').value);
			setElementPaths(solution, problemData.figure.edges, solutionData.vertices);
		} catch(error) {
			return;
		}

		populateEpsilonTable(document.getElementById('epsilon-table-body'), problemData.epsilon, problemData.figure.edges, problemData.figure.vertices, solutionData.vertices);
	}

	redraw();
</script>

	</body>
</html>